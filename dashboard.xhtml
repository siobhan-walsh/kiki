<!DOCTYPE html>
<html lang="en">

  <!-- View -->
  <headReplace metal:use-macro="/templating/head2.xhtml/meta_head">
  </headReplace>

  <body>


    <navReplace metal:use-macro="./templating/nav.xhtml/nav_bar">
    </navReplace>

      <div id='bg'></div>

          
          <!--<div class='large-1 columns'>&nbsp;</div>-->



          

   
          <div id='about' class=' large-12 columns'>
         
             

<header>
    <h3>Hello Admin, You're Awesome</h3>
 

  </header>
 

    <div class="pushy"></div>
  
              
              
              
              
              
       
<div class="row">
  <hr/>
  <div class="small-12 columns">
    <h1>Add  menu items to the list</h1>
  </div>
  <div class="small-12 large-4 columns">   
    <form id="item-form">
      <div class="row collapse">
        <div class="small-3 columns"><span class="prefix">Item:</span></div>
        <div class="small-9 columns">
          <input id="item-input" type="text" placeholder="add item..." autofocus="autofocus"/>
        </div>
      </div>
      <div class="row collapse">
        <div class="small-3 columns"><span class="prefix">Price:</span></div>
        <div class="small-9 columns">
          <input id="item-price" type="number" placeholder="add price..."/>
        </div>
      </div>
      <div class="row">
        <div class="small-12 columns">
          <button id="add-item" type="submit" class="expand">Add Item</button>
        </div>
      </div>
    </form>
  </div>
  <div id="items-view" class="small-12 large-8 columns">
    <table id="main" class="small-12">
      <thead class="expand">
        <tr>
          <th>Item</th>
          <th>Price</th>
          <th>Action</th>
        </tr>
        <tbody id="table-body"></tbody>
      </thead>
    </table>
  </div>
  <div id="total-view" class="small-12 columns"></div>
  <hr/>
</div>

  <table id="main" class="small-12">
    <thead class="expand">
      <tr>
        <th>Item</th>
        <th>Price</th>
        <th>Action</th>
      </tr>
      <tbody id="table-body"></tbody>
    </thead>
  </table>


  <td id="name"></td>
  <td id="price"></td>
  <td>
    <button id="delete" class="secondary tiny expand">Delete</button>
  </td>


  <table id="total" class="right">
    <tbody>
      <tr>
        <th>Total:</th>
        <th id="total-price"></th>
      </tr>
    </tbody>
  </table>



<script>
    
    
    
    // Model
var Item = Backbone.Model.extend({});


// Collection
var ItemCollection = Backbone.Collection.extend({
  model: Item,
  
  //comparator: 'name',
  
  // Price Comparator (lowest to highest price)
  comparator: function(a,b) {
    return b.get('price') - a.get('price');
  },
  
  localStorage: new Backbone.LocalStorage('ItemCart'),
  
  // Get all the names in the collection
  getNames: function() {
    this.each(function(item) {
      //return item;
      console.log(item.get('name'));
    });
  },

  // Get the total price using Underscore's reduce function
  getTotal: function() {
    return this.reduce( function(memo, item) {
      return memo + item.get('price');
    }, 0);
  }
});


// View
var AddItemView = Backbone.View.extend({
  el: '#item-form',
  
  events: {
    'click #add-item': 'addItem'
  },
  
  addItem: function(e) {
    e.preventDefault();
    
    var newItem = {};
    var price = this.$('#item-price').val();

    // Capitalize text
    newItem.name = this.$('#item-input').val();
    // Convert price to number
    newItem.price = parseFloat(price);

    // Store inputs in object
    var item = new Item({
      name: newItem.name,
      price: newItem.price
    });
    
    // Add to collection
    this.collection.create(item);
    
    // Clear form
    this.el.reset();
    
    // Focus back on first element
    this.$('#item-input').focus();
  }
});


// View
var ItemCollectionView = Backbone.View.extend({
  el: '#table-body',
  
  template: _.template($('#itemCollection-template').html()),
  
  initialize: function() {
    this.listenTo(this.collection, 'add', this.renderItem);
  },
  
  render: function() {
    this.collection.each(function(item) {
      this.renderItem(item);
    }, this);
    
    this.collection.fetch();
    
    return this;
  },
  
  renderItem: function(item) {
    var itemView = new ItemView({ model: item });
    this.$el.append(itemView.render().el);
  }
});


// View
var ItemView = Backbone.View.extend({
  tagName: 'tr',
  
  template: _.template($('#item-template').html()),
  
  bindings: {
    "#name": { 
      observe: 'name',
      onGet: 'formatName'
    },
    '#price': { 
      observe: 'price', 
      onGet: 'formatPrice'
    }
  },
  
  events: {
    'click #delete': 'deleteItem'
  },
  
  render: function() {
    this.$el.html(this.template({}));
    this.stickit();
    return this;
  },
  
  formatPrice: function (price) {
    return '$ ' + price.toFixed(2);
  },
  
  formatName: function (name) {
    return name.substring(0,1).toUpperCase() + name.substring(1, name.length);
  },
  
  deleteItem: function() {
    console.log('Removing Item: ' + this.model.get('name'));
    this.model.destroy(); // delete model
    this.remove(); // delete view
  }
});


// Should the TotalView be referencing a TotalModel?
// How should TotalModel get the total sum?
var TotalView = Backbone.View.extend({
  el: '#total-view',
  
  initialize: function() {
    this.listenTo(this.collection, 'add remove', this.render);
  },
  
  template: _.template($('#total-template').html()),
  
  render: function() {
    var total = this.showTotal();
    
    this.$el.html(this.template({}));
    this.$el.find('#total-price').html(total);
    return this;
  },
  
  showTotal: function() {
    return '$ ' + this.collection.getTotal().toFixed(2);
  }
});

var itemCollection = new ItemCollection([
  {
    name: 'Paprika',
    price: 5.99
  },
  {
    name: 'Turmeric', 
    price: 3.99
  },
  {
    name: 'Cayenne',
    price: 1.95
  },
  {
    name: 'Iditarod',
    price: 9.99
  }
]);


var itemsView = new ItemCollectionView({ collection: itemCollection });
var addPersonView = new AddItemView({ collection: itemCollection });
var totalView = new TotalView({ collection: itemCollection });

$('#main').append(itemsView.render().el);
console.log(itemsView);
$('#total-view').append(totalView.render().el);
    
    
    
    
    </script>
    

        
     
 </div>
    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/products.js"></script>
    <script src="js/login.js"></script>
    <footerReplace metal:use-macro="/templating/footer.xhtml/page_footer">
    </footerReplace>
  
    </body>
</html>